#NAME probe19.txt #LABEL "Y Angle Subroutine to support Probing in HSM Works / Fusin 360"


Unterprogramm fuer die Antastfunktion aus HSM Works / Fusion 360 in Verbindung mit dem Probing PP

Most of the code is based on the Fusion 360 Postprozessor for Mach3 mith probing functionality by mlm solutions. http://www.mlmsolutions.biz/fusion_post_mach3_probing.php
Thank you for your work, and well documented changes in the code so its easy to adopt.


Probe Variablen aus Postprozessor Einstellung

#100 (Anfahrgeschwindigkeit)
#102 (Ausfahrgeschwindigkeit für Messung)
#103 (Rueckzug fuer zweiten Antastvorgang mit langsamer Geschwindikeit)
#105 (zweiter Langsamer Antastvorgang mit langsamer Geschwindigkeit? 1 - JA // 0 - NEIN)
#106 (Beenutze G0 Eilgang für Positionierung? 1 - JA // 0 - NEIN)

Globale Antast Variablen

#104 (HSM Works Einfahrvorschub des Probe Werkzeugs)
#4 (Probe cycle Uebermittelt vom PP)
#5 (Startpunkt X)
#6 (Startpunkt Y)
#7 (Startpunkt Z)
#9 (The final depth position along the probe axis to touch the part) 
#10 (The unsigned incremental distance from the top of the part along the probe axis where the probe will touch the part.)
#13 (Abstand Probe zu Werkstueck)
#14 (max. Abstand Taster - Kante)
#15 (Rueckzugshoehe HSM Works)

Antast Modus spezifische Variablen

#21 (Ermittelte Kante Y-Achse, Tastkugel nicht beruecksichtigt)
#11 (Richtung der Antastung in HSM Works / positiv=-1 / negativ=1)
#19 (Abstand zwischen 2 Tastpunkten)

Beamicon2 Variablen

#909 (letzter Nullpunkt)

Beamicon2 Eingaenge

#I9 (Eingang fuer Kantentaster)

Unterprogramm interne Variablen

#22 (verwendeter Nullpunkt G54..G59)
#26 (Winkel für verdrehung)


%

IF #4=0 | #104=0 | #9=0 THEN (Parameter nicht gesetzt)
    PRINT "missing Parameters, should be generated by Postprozessor"
    M2
ENDIF
#22=#909 (verwendeter Nullpunkt G54..G59)
IF #22=0 THEN
    PRINT "no offset G54..G59 selected"
    M2
ENDIF

G21 G40 G90 G94

G1 F=#104 Z=#9 (Z auf Probehoehe aus HSM Works fahren)

IF #105=1 & #106=1 & #11=1 THEN (Ist zweites Antasten und G0 fuer positionierung aktiviert? Antastrichtung Negativ?)
   
    G0 X=#5-#19/2 (Fahre zur ersten Kante in X Richtung)
    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y-#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF
    #21=Y (Ermittelte Kante Y-Achse, Tastkugel nicht beruecksichtigt)
        
    G0 Y=Y-#13 (Fahre zurueck in die Y Startposition)
    G0 X=#5+#19/2(Fahre zur zweiten Kante in X Richtung)

    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y-#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
         PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    #26=ATAN((Y-#21)/#19)*(180/(4*ATAN(1))) (Setze Variable Winkel auf den errechneten Winkel der Verdrehung)
    G0 Y=#6 (Fahre zurueck zum Y Startpunkt)
    PRINT "Winkel R=";#26
    G68 X0 Y0 R=#26 (Setze Winkelverdrehung nach errechnetem Winkel)
    RETURN    
ENDIF

(################################################################################################################################################################################)

IF #105=1 & #106=1 & #11=-1 THEN (Ist zweites Antasten und G0 fuer positionierung aktiviert? Antastrichtung Positiv?)
   
    G0 X=#5-#19/2 (Fahre zur ersten Kante in X Richtung)
    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y+#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF
    #21=Y (Ermittelte Kante Y-Achse, Tastkugel nicht beruecksichtigt)
        
    G0 Y=Y+#13 (Fahre zurueck in die Y Startposition)
    G0 X=#5+#19/2(Fahre zur zweiten Kante in X Richtung)

    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y+#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
         PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    #26=ATAN((Y-#21)/#19)*(180/(4*ATAN(1))) (Setze Variable Winkel auf den errechneten Winkel der Verdrehung)
    G0 Y=#6 (Fahre zurueck zum Y Startpunkt)
    PRINT "Winkel R=";#26
    G68 X0 Y0 R=#26 (Setze Winkelverdrehung nach errechnetem Winkel)
    RETURN    
ENDIF

(################################################################################################################################################################################)

IF #105=1 & #106=1 & #11=1 THEN (Ist zweites Antasten und G0 fuer positionierung Deaktiviert? Antastrichtung Negativ?)
   
    G1 F=#104 X=#5-#19/2 (Fahre zur ersten Kante in X Richtung)
    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y-#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF
    #21=Y (Ermittelte Kante Y-Achse, Tastkugel nicht beruecksichtigt)
        
    G1 F=#104 Y=Y-#13 (Fahre zurueck in die Y Startposition)
    G1 F=#104 X=#5+#19/2(Fahre zur zweiten Kante in X Richtung)

    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y-#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y+#13+#14
    IF #I9=0 THEN 
         PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    #26=ATAN((Y-#21)/#19)*(180/(4*ATAN(1))) (Setze Variable Winkel auf den errechneten Winkel der Verdrehung)
    G1 F=#104 Y=#6 (Fahre zurueck zum Y Startpunkt)
    PRINT "Winkel R=";#26
    G68 X0 Y0 R=#26 (Setze Winkelverdrehung nach errechnetem Winkel)
    RETURN    
ENDIF

(################################################################################################################################################################################)

IF #105=1 & #106=0 & #11=-1 THEN (Ist zweites Antasten und G0 fuer positionierung Deaktiviert? Antastrichtung Positiv?)
   
    G1 F=#104 X=#5-#19/2 (Fahre zur ersten Kante in X Richtung)
    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y+#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF
    #21=Y (Ermittelte Kante Y-Achse, Tastkugel nicht beruecksichtigt)
        
    G1 F=#104 Y=Y+#13 (Fahre zurueck in die Y Startposition)
    G1 F=#104 X=#5+#19/2(Fahre zur zweiten Kante in X Richtung)

    (Taste mit schneller Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#100 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
        PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    G1 F=#100 Y=Y+#103 (Fahre um Rueckzug fuer zweiten Antastvorgang weg vom Werkstueck)

    (Taste mit langsamer Geschwindigkeit an bis zum ausloesen, fahre dann zurueck bis der Taster nicht mehr ausloest)
    G1 F=#102 UNTIL #I9=1 Y=Y-#13-#14
    IF #I9=0 THEN 
         PRINT "front edge not found"
        M2 
    ENDIF
    G1 F=#102 UNTIL #I9=0 Y=#6
    IF #I9=1 THEN 
        PRINT "probe switch not released"
        M2 
    ENDIF

    #26=ATAN((Y-#21)/#19)*(180/(4*ATAN(1))) (Setze Variable Winkel auf den errechneten Winkel der Verdrehung)
    G1 F=#104 Y=#6 (Fahre zurueck zum Y Startpunkt)
    PRINT "Winkel R=";#26
    G68 X0 Y0 R=#26 (Setze Winkelverdrehung nach errechnetem Winkel)
    RETURN    
ENDIF

(################################################################################################################################################################################)

ELSE (ohne zweiten Antastvorgang nich unterstuezt)
    PRINT "only one probing cycle at fast speed is currently not supported. Select second Probe cycle"
    M2
ENDIF

Simulation: 
PRINT "Edge-finder with 3D-probe (simulation)"
RETURN